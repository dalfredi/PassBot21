# PassBot21

Телеграм-бот для оформления заявок на проход гостей в кампусы Школы 21.  
Бот был написан в команде в рамках хакатона по разработке ботов для внутренних нужд школы
и занял 1 место в своей категории.  
Состав команды:
[Александр](https://github.com/skiflok),
[Дарья](https://github.com/hemelia21),
[Михаил](https://github.com/PiandTo),
[Фёдор](https://github.com/postfedor).  
Попробовать: [@pass21_bot](https://t.me/pass21_bot)

#### Стек

- [Spring Boot](https://github.com/spring-projects/spring-boot)
- [Spring Data JPA](https://github.com/spring-projects/spring-data-jpa) (Hibernate)
- [PostgreSQL](https://github.com/postgres/postgres)
- [TelegramBots](https://github.com/rubenlagus/TelegramBots) (Long Polling API)

#### Решаемая проблема

Бот должен упростить и автоматизировать процесс
оформления заявки на посещение гостем кампуса Школы 21.
Этот процесс состоит из трёх этапов:

1) Создание заявки студентом школы (нужно заполнить данные гостя)
2) Рассмотрение заявки сотрудником школы (одобрение или отклонение)
3) Формирование списка гостей, которые могут посетить школу в определённый день, и передача его охране кампуса

#### Возможности

Пользователь может выполнить следующие команды:

- Зарегистрироваться через ник в интранете школы
- Ввести свои данные, необходимые для оформления заявки
- Создать новую заявку
- Показать свои текущие заявки и их статусы
- Вывести справку

Сотруднику школы также доступна команда,
которая выводит все активные заявки с кнопками `Одобрить` и `Отклонить`

#### Особенности реализации

Процесс обработки сообщений пользователей абстрагирован на уровне команд. Комманды могут иметь аргументы, то есть данные, которые пользователь должен отправить,
чтобы успешно завершить действие. Например, чтобы выполнить команду
"Создать новую заявку", пользователь должен сначала отправить
ФИО гостя, а потом дату посещения кампуса. Приложение сохраняет сообщения, которые вводит пользователь, и только когда
введены все необходимые данные для оформления заявки, добавляет заявку в базу данных.

В основе архитектуры приложения лежит принцип инверсии управления (IoC). Реализован контейнер,
который получает обновления от Телеграма (посредством Long Polling) и помещает их в нужный контекст.
Контекст состоит из: 
1) текущего чата (пользователя) 
2) текущей команды
3) текущего состояния диалога с пользователем (какой ввод ожидается от пользователя).

За логику выполнения каждой команды отвечает отдельный класс,
который наследуется от абстрактного класса Command. Чтобы добавить новую команду, достаточно создать для неё новый класс
и переопределить, как минимум, метод execute().

#### Как установить и запустить
1) Подготовить базу данных
   - Установить PostgreSQL
   - Создать новую БД
   - Создать нужные таблицы с помощью скрипта schema.sql (src/main/resources/sql/schema.sql)
2) Создать нового бота через [@BotFather](https://t.me/BotFather).
3) Отредактировать application.properties
   - Ввести URL базы данных созданной в п.1
   - Ввести логин и пароль от БД
   - Ввести имя бота и его токен
4) Выполнить `mvn spring-boot:run`

